<!-- Enhanced Dashboard with Full CRUD Operations -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoostMon Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: contain;
            background: #f5f5f5;
            padding: 4px;
        }

        .header-title {
            flex: 1;
        }

        .header-left h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header-left p {
            color: #666;
            font-size: 14px;
        }

        .status-badge {
            display: inline-block;
            background: #2ecc71;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.offline {
            background: #e74c3c;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-content {
            font-size: 32px;
            font-weight: 700;
            color: #764ba2;
            margin-bottom: 8px;
        }

        .card-label {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* Add Entry Form Styles */
        .add-entry-form {
            background: #f9f9f9;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-note {
            grid-column: 1 / -1;
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-left: 3px solid #667eea;
            border-radius: 4px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-wrapper {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        th {
            background: #f9f9f9;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-active {
            background: #d4edda;
            color: #155724;
        }

        .badge-paused {
            background: #fff3cd;
            color: #856404;
        }

        .badge-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-bot {
            background: #e7f3ff;
            color: #004085;
        }

        .badge-user {
            background: #fff3e0;
            color: #e65100;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Editable Cell Styles */
        .editable-cell {
            cursor: pointer;
            position: relative;
            padding: 8px 12px !important;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .editable-cell:hover {
            background: #f0f0f0;
        }

        .edit-input {
            width: 100%;
            padding: 6px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .edit-input-field {
            padding: 8px !important;
            border: 2px solid #667eea !important;
            border-radius: 4px !important;
            font-size: 14px !important;
            font-family: inherit !important;
        }

        .edit-input-field:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            border-color: #5568d3 !important;
        }

        .save-edit-btn,
        .cancel-edit-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s;
        }

        .save-edit-btn {
            background: #2ecc71;
            color: white;
        }

        .save-edit-btn:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }

        .cancel-edit-btn {
            background: #e74c3c;
            color: white;
        }

        .cancel-edit-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .edit-actions {
            display: flex;
            gap: 6px;
            margin-top: 4px;
        }

        .edit-actions button {
            flex: 1;
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .edit-actions .save {
            background: #2ecc71;
            color: white;
        }

        .edit-actions .cancel {
            background: #e74c3c;
            color: white;
        }

        .action-column {
            text-align: right;
            white-space: nowrap;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .modal-content h3 {
            margin-bottom: 16px;
            color: #333;
        }

        .modal-content p {
            margin-bottom: 24px;
            color: #666;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-buttons .confirm {
            background: #e74c3c;
            color: white;
        }

        .modal-buttons .confirm:hover {
            background: #c0392b;
        }

        .modal-buttons .cancel {
            background: #bdc3c7;
            color: white;
        }

        .modal-buttons .cancel:hover {
            background: #95a5a6;
        }

        /* Alert/Toast Styles */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .footer {
            text-align: center;
            color: white;
            padding: 20px;
            font-size: 12px;
        }

        .footer-note {
            font-size: 12px;
            color: #666;
            margin-top: 12px;
            padding: 12px;
            background: #f9f9f9;
            border-left: 3px solid #e74c3c;
            border-radius: 4px;
            text-align: left;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }

            .header-left {
                flex-direction: column;
                width: 100%;
            }

            .header-logo {
                width: 50px;
                height: 50px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .card-content {
                font-size: 24px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            td, th {
                padding: 8px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        .role-selector-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #667eea;
        }

        .role-selector-container {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .role-selector-container label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-selector-container select {
            padding: 10px 16px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
            min-width: 250px;
        }

        .role-selector-container select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            border-color: #5568d3;
        }

        .role-info {
            padding: 8px 16px;
            background: #f0f4ff;
            border-radius: 6px;
            color: #667eea;
            font-weight: 600;
            font-size: 13px;
        }

        .table-controls {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .control-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group input,
        .control-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            cursor: pointer;
        }

        .control-group input {
            cursor: text;
            flex: 1;
            min-width: 200px;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .placeholder-state {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <img src="/images/boostmon.png" alt="BoostMon Logo" class="header-logo">
                <div class="header-title">
                    <h1>BoostMon Dashboard</h1>
                    <p>Discord Bot Management</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="status-badge" id="statusBadge">Loading...</div>
                <a href="/auth/logout" style="padding: 8px 16px; background: #f0f0f0; color: #333; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Logout</a>
            </div>
        </header>

        <div class="dashboard-grid" id="statsGrid">
            <div class="card">
                <h2>üìä Active Timers</h2>
                <div class="card-content" id="activeTimers">0</div>
                <div class="card-label">Timed roles currently active</div>
            </div>
            <div class="card">
                <h2>‚è∞ Scheduled Reports</h2>
                <div class="card-content" id="scheduledReports">0</div>
                <div class="card-label">Role status reports</div>
            </div>
            <div class="card">
                <h2>üóëÔ∏è Auto-Purge Settings</h2>
                <div class="card-content" id="autopurgeCount">0</div>
                <div class="card-label">Configured channels</div>
            </div>
        </div>

        <div class="section" id="timersSection">
            <h2>‚è±Ô∏è Active Timers</h2>
            
            <!-- Role Selector -->
            <div class="role-selector-section">
                <div class="role-selector-container">
                    <label for="roleFilter">Filter by Role:</label>
                    <select id="roleFilter" onchange="onRoleSelected()">
                        <option value="">-- Select a Role --</option>
                    </select>
                    <span class="role-info" id="roleInfo"></span>
                </div>
            </div>

            <!-- Add Entry Form (Only shown after role is selected) -->
            <div class="add-entry-form" id="addEntryForm" style="display: none;">
                <h3 style="color: #667eea; margin-bottom: 16px; font-size: 16px;">‚ûï Add New Timer Entry</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newUser">Select User</label>
                        <select id="newUser" required>
                            <option value="">-- Select User --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newMinutes">Minutes</label>
                        <input type="number" id="newMinutes" placeholder="30" min="1" max="10080" required>
                    </div>
                    <div class="form-group">
                        <label for="newChannel">Select Channel (Optional)</label>
                        <select id="newChannel">
                            <option value="">-- DM User --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addNewTimer()" style="margin-top: 24px;">‚ûï Add Entry</button>
                    </div>
                </div>
                <div class="form-note">
                    ‚ÑπÔ∏è If "DM User" is selected, a DM will be sent to the user when their time is about to expire.
                </div>
            </div>

            <!-- Table Controls (Only shown after role is selected) -->
            <div class="table-controls" id="tableControls" style="display: none;">
                <div class="control-group">
                    <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterAndSortTimers()">
                    <select id="statusFilter" onchange="filterAndSortTimers()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="paused">Paused</option>
                        <option value="expired">Expired</option>
                    </select>
                    <select id="sortBy" onchange="filterAndSortTimers()">
                        <option value="expires-asc">Expires Soonest</option>
                        <option value="expires-desc">Expires Latest</option>
                        <option value="time-asc">Time Remaining (Low to High)</option>
                        <option value="time-desc">Time Remaining (High to Low)</option>
                        <option value="user-asc">User (A-Z)</option>
                        <option value="user-desc">User (Z-A)</option>
                    </select>
                </div>
            </div>

            <div id="timersList" class="placeholder-state">
                <div class="empty-state">
                    <div class="empty-state-icon">üëÜ</div>
                    <p>Select a role above to view timers</p>
                </div>
            </div>
        </div>

        <div class="section" id="reportsSection">
            <h2>üìã Scheduled Reports</h2>
            <div id="reportsList" class="loading">Loading reports...</div>
        </div>

        <div class="section" id="autopurgeSection">
            <h2>üóëÔ∏è Auto-Purge Settings</h2>
            <div id="autopurgeList" class="loading">Loading settings...</div>
        </div>

        <div class="footer">
            <p>BoostMon Dashboard ‚Ä¢ Last Updated: <span id="lastUpdate">Never</span></p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Confirm Delete</h3>
            <p id="confirmMessage">Are you sure you want to delete this timer?</p>
            <div class="modal-buttons">
                <button class="confirm" onclick="confirmDelete()">Yes, Delete</button>
                <button class="cancel" onclick="cancelDelete()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let guildId = null;
        let pendingDeleteId = null;
        let allTimers = [];
        let selectedRoleId = null;
        let allRoles = [];
        let filteredTimers = [];

        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/auth/user');
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return false;
                }
                return true;
            } catch (err) {
                window.location.href = '/login.html';
                return false;
            }
        }

        // Get guild from URL query parameter
        function getGuildId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('guild');
        }

        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alert, container.firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 4000);
        }

        async function loadDashboard() {
            try {
                guildId = getGuildId();
                if (!guildId) {
                    window.location.href = '/guild-select.html';
                    return;
                }
                
                const url = `/api/dashboard?guildId=${guildId}`;
                const response = await fetch(url);
                
                if (response.status === 403 || response.status === 401) {
                    console.warn('Access denied to guild:', guildId);
                    window.location.href = '/login.html';
                    return;
                }
                
                if (!response.ok) throw new Error('Failed to load dashboard data');
                
                const data = await response.json();
                updateDashboard(data);
            } catch (err) {
                console.error('Dashboard error:', err);
                document.getElementById('statusBadge').textContent = 'ERROR';
                document.getElementById('statusBadge').classList.add('offline');
            }
        }

        function updateDashboard(data) {
            const statusBadge = document.getElementById('statusBadge');
            if (data.botStatus === 'online') {
                statusBadge.textContent = 'üü¢ ONLINE';
                statusBadge.classList.remove('offline');
            } else {
                statusBadge.textContent = 'üî¥ OFFLINE';
                statusBadge.classList.add('offline');
            }

            document.getElementById('activeTimers').textContent = data.stats.activeTimers || 0;
            document.getElementById('scheduledReports').textContent = data.stats.scheduledReports || 0;
            document.getElementById('autopurgeCount').textContent = data.stats.autopurgeSettings || 0;

            allTimers = data.timers || [];
            
            // Extract unique roles from timers
            const roleMap = new Map();
            allTimers.forEach(timer => {
                if (!roleMap.has(timer.roleId)) {
                    roleMap.set(timer.roleId, timer.role);
                }
            });
            
            allRoles = Array.from(roleMap.entries()).map(([id, name]) => ({ id, name }))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            // Populate role selector
            const roleSelect = document.getElementById('roleFilter');
            const currentValue = roleSelect.value;
            roleSelect.innerHTML = '<option value="">-- Select a Role --</option>';
            
            allRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                roleSelect.appendChild(option);
            });
            
            // Restore previous selection if still available
            if (currentValue && allRoles.find(r => r.id === currentValue)) {
                roleSelect.value = currentValue;
                // Don't trigger change, just update display
                updateRoleInfo();
                filterAndSortTimers();
            } else {
                // Clear selection and hide form/table
                selectedRoleId = null;
                document.getElementById('addEntryForm').style.display = 'none';
                document.getElementById('tableControls').style.display = 'none';
                document.getElementById('roleInfo').textContent = '';
            }
            
            updateReportsTable(data.reports || []);
            updateAutopurgeTable(data.autopurge || []);

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function onRoleSelected() {
            selectedRoleId = document.getElementById('roleFilter').value;
            
            if (!selectedRoleId) {
                document.getElementById('addEntryForm').style.display = 'none';
                document.getElementById('tableControls').style.display = 'none';
                document.getElementById('timersList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üëÜ</div>
                        <p>Select a role above to view timers</p>
                    </div>
                `;
                return;
            }
            
            // Show form and controls
            document.getElementById('addEntryForm').style.display = 'block';
            document.getElementById('tableControls').style.display = 'block';
            
            // Pre-fill the role in the add form (set hidden value or show it)
            // Actually, we'll let them select users from the filtered role
            
            updateRoleInfo();
            filterAndSortTimers();
        }

        function updateRoleInfo() {
            const selectedRoleId = document.getElementById('roleFilter').value;
            if (!selectedRoleId) return;
            
            const role = allRoles.find(r => r.id === selectedRoleId);
            const timerCount = allTimers.filter(t => t.roleId === selectedRoleId).length;
            
            const infoEl = document.getElementById('roleInfo');
            infoEl.textContent = `${timerCount} timer${timerCount !== 1 ? 's' : ''} active`;
        }

        function filterAndSortTimers() {
            if (!selectedRoleId) {
                filteredTimers = [];
                return;
            }
            
            // Filter by role
            let filtered = allTimers.filter(t => t.roleId === selectedRoleId);
            
            // Filter by status
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            if (statusFilter === 'active') {
                filtered = filtered.filter(t => !t.paused && t.remaining > 0);
            } else if (statusFilter === 'paused') {
                filtered = filtered.filter(t => t.paused);
            } else if (statusFilter === 'expired') {
                filtered = filtered.filter(t => t.remaining <= 0);
            }
            
            // Filter by user search
            const userSearch = document.getElementById('userSearch')?.value.toLowerCase() || '';
            if (userSearch) {
                filtered = filtered.filter(t => t.user.toLowerCase().includes(userSearch));
            }
            
            // Sort
            const sortBy = document.getElementById('sortBy')?.value || 'expires-asc';
            
            switch(sortBy) {
                case 'expires-asc':
                    filtered.sort((a, b) => a.expiresAt - b.expiresAt);
                    break;
                case 'expires-desc':
                    filtered.sort((a, b) => b.expiresAt - a.expiresAt);
                    break;
                case 'time-asc':
                    filtered.sort((a, b) => a.remaining - b.remaining);
                    break;
                case 'time-desc':
                    filtered.sort((a, b) => b.remaining - a.remaining);
                    break;
                case 'user-asc':
                    filtered.sort((a, b) => a.user.localeCompare(b.user));
                    break;
                case 'user-desc':
                    filtered.sort((a, b) => b.user.localeCompare(a.user));
                    break;
            }
            
            filteredTimers = filtered;
            updateTimersTable(filteredTimers);
            updateRoleInfo();
        }

        function updateTimersTable(timers) {
            const container = document.getElementById('timersList');
            
            if (timers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚è∞</div>
                        <p>No timers match your filters</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Time Remaining</th>
                                <th>Expires</th>
                                <th>Status</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            timers.forEach(timer => {
                const badge = timer.paused ? 'badge-paused' : timer.remaining <= 0 ? 'badge-expired' : 'badge-active';
                const status = timer.paused ? '‚è∏Ô∏è PAUSED' : timer.remaining <= 0 ? 'üî¥ EXPIRED' : 'üü¢ ACTIVE';
                
                html += `
                    <tr>
                        <td>${timer.user}</td>
                        <td class="editable-cell" onclick="editTime(${timer.id}, '${timer.formattedTime}')" title="Click to edit">
                            ${timer.formattedTime} ‚úèÔ∏è
                        </td>
                        <td>${new Date(timer.expiresAt).toLocaleString()}</td>
                        <td><span class="badge ${badge}">${status}</span></td>
                        <td class="action-column">
                            <div class="action-buttons">
                                <button class="delete-btn" onclick="deleteTimer(${timer.id}, '${timer.user}', '${timer.role}')">‚úï</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function editTime(timerId, currentTime) {
            const cell = event.target.closest('.editable-cell');
            if (!cell) return;
            
            // Find the timer and calculate minutes
            const timer = allTimers.find(t => t.id === timerId);
            if (!timer) {
                console.error('Timer not found:', timerId);
                showAlert('Error: Timer not found', 'error');
                return;
            }
            
            // Calculate minutes from remaining milliseconds
            const minutes = Math.ceil(timer.remaining / 60000);
            console.log(`[Edit] Timer ${timerId}: remaining=${timer.remaining}ms, minutes=${minutes}`);
            
            if (minutes < 1 || isNaN(minutes)) {
                showAlert('Invalid timer data', 'error');
                return;
            }
            
            // Replace cell content with editable input
            cell.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <input type="text" class="edit-input-field" id="edit-input-${timerId}" value="${minutes}" style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 4px; font-size: 14px;">
                    <div style="display: flex; gap: 4px;">
                        <button class="save-edit-btn" onclick="saveTime(${timerId})">‚úì Save</button>
                        <button class="cancel-edit-btn" onclick="cancelEdit(${timerId})">‚úï Cancel</button>
                    </div>
                </div>
            `;
            
            // Focus and select the input
            const input = document.getElementById(`edit-input-${timerId}`);
            if (input) {
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 0);
            }
        }

        async function saveTime(timerId) {
            const input = document.getElementById(`edit-input-${timerId}`);
            if (!input) {
                showAlert('Error: Input field not found', 'error');
                return;
            }
            
            const value = input.value.trim();
            const minutes = parseInt(value);

            // Validation
            if (!value || isNaN(minutes)) {
                showAlert('Please enter a valid number of minutes', 'error');
                return;
            }
            
            if (minutes <= 0) {
                showAlert('Minutes must be greater than 0', 'error');
                return;
            }
            
            if (minutes > 10080) {
                showAlert('Minutes cannot exceed 10080 (7 days)', 'error');
                return;
            }

            console.log(`[Save] Updating timer ${timerId} to ${minutes} minutes`);

            try {
                const response = await fetch(`/api/timer/update?guildId=${guildId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timerId, minutes })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update timer');
                }

                const result = await response.json();
                console.log('[Save] Update successful:', result);
                showAlert('Timer updated successfully!', 'success');
                loadDashboard();
            } catch (err) {
                console.error('Error saving time:', err);
                showAlert(`Error: ${err.message}`, 'error');
                loadDashboard();
            }
        }

        function cancelEdit(timerId) {
            loadDashboard();
        }

        function deleteTimer(timerId, userName, roleName) {
            pendingDeleteId = timerId;
            document.getElementById('confirmMessage').textContent = 
                `Are you sure you want to delete the timer for ${userName} with role ${roleName}?`;
            document.getElementById('confirmModal').classList.add('active');
        }

        async function confirmDelete() {
            if (!pendingDeleteId) return;

            try {
                const response = await fetch(`/api/timer/delete?guildId=${guildId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timerId: pendingDeleteId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete timer');
                }

                showAlert('Timer deleted successfully!', 'success');
                cancelDelete();
                loadDashboard();
            } catch (err) {
                console.error('Error deleting timer:', err);
                showAlert(`Error: ${err.message}`, 'error');
                cancelDelete();
            }
        }

        function cancelDelete() {
            pendingDeleteId = null;
            document.getElementById('confirmModal').classList.remove('active');
        }

        async function addNewTimer() {
            const userId = document.getElementById('newUser').value.trim();
            const minutes = parseInt(document.getElementById('newMinutes').value);
            const roleId = selectedRoleId; // Use the selected role from dropdown
            const channelId = document.getElementById('newChannel').value.trim() || null;

            if (!userId || !minutes || !roleId) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            if (minutes <= 0) {
                showAlert('Minutes must be greater than 0', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/timer/add?guildId=${guildId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, minutes, roleId, channelId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add timer');
                }

                showAlert('Timer added successfully!', 'success');
                document.getElementById('newUser').value = '';
                document.getElementById('newMinutes').value = '';
                document.getElementById('newChannel').value = '';
                loadDashboard();
            } catch (err) {
                console.error('Error adding timer:', err);
                showAlert(`Error: ${err.message}`, 'error');
            }
        }

        function updateReportsTable(reports) {
            const container = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No scheduled reports</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Role</th>
                            <th>Channel</th>
                            <th>Interval</th>
                            <th>Last Report</th>
                            <th>Next Report</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            reports.forEach(report => {
                html += `
                    <tr>
                        <td>${report.role}</td>
                        <td>${report.channel}</td>
                        <td>${report.interval} min</td>
                        <td>${report.lastReport || 'Never'}</td>
                        <td>${report.nextReport}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateAutopurgeTable(autopurge) {
            const container = document.getElementById('autopurgeList');
            
            if (autopurge.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üóëÔ∏è</div>
                        <p>No auto-purge settings</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Channel</th>
                            <th>Type</th>
                            <th>Lines per Purge</th>
                            <th>Interval</th>
                            <th>Last Purge</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            autopurge.forEach(setting => {
                const typeBadge = setting.type === 'bot' ? 'badge-bot' : 'badge-user';
                const typeText = setting.type === 'bot' ? 'ü§ñ Bot' : setting.type === 'user' ? 'üë§ User' : 'üîÄ Both';
                
                html += `
                    <tr>
                        <td>${setting.channel}</td>
                        <td><span class="badge ${typeBadge}">${typeText}</span></td>
                        <td>${setting.lines}</td>
                        <td>${setting.interval} min</td>
                        <td>${setting.lastPurge || 'Never'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        /**
         * Load dropdown data (users, roles, channels) for the add entry form
         */
        async function loadDropdownData() {
            try {
                const response = await fetch(`/api/dropdown-data?guildId=${guildId}`);
                
                if (!response.ok) {
                    console.warn('Failed to load dropdown data:', response.status);
                    // Don't show error - form will still work with manual IDs
                    return;
                }
                
                const data = await response.json();
                
                // Populate User dropdown
                const userSelect = document.getElementById('newUser');
                if (userSelect && data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.displayName || user.name;
                        userSelect.appendChild(option);
                    });
                }
                
                // Populate Role dropdown
                const roleSelect = document.getElementById('newRole');
                if (roleSelect && data.roles && data.roles.length > 0) {
                    data.roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        roleSelect.appendChild(option);
                    });
                }
                
                // Populate Channel dropdown
                const channelSelect = document.getElementById('newChannel');
                if (channelSelect && data.channels && data.channels.length > 0) {
                    data.channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.id;
                        option.textContent = '#' + channel.name;
                        channelSelect.appendChild(option);
                    });
                }
                
                console.log(`[Dropdown] Loaded: ${data.users.length} users, ${data.roles.length} roles, ${data.channels.length} channels`);
            } catch (err) {
                console.error('Error loading dropdown data:', err);
                // Don't show error - form will still work
            }
        }

        async function loadDashboardAndDropdowns() {
            await loadDashboard();
            await loadDropdownData();
        }

        // Load dashboard on page load
        (async () => {
            const isAuth = await checkAuth();
            if (isAuth) {
                loadDashboard();
                loadDropdownData();
                setInterval(loadDashboard, 30000);
                setInterval(loadDropdownData, 60000); // Refresh dropdowns every minute
            }
        })();
    </script>
</body>
</html>
