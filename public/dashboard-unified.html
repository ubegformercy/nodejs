<!-- Enhanced Unified Dashboard with Grid & Tabbed View Toggle -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoostMon Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: contain;
            background: #f5f5f5;
            padding: 4px;
        }

        .header-title {
            flex: 1;
        }

        .header-left h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header-left p {
            color: #666;
            font-size: 14px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            background: #f0f0f0;
            padding: 6px;
            border-radius: 8px;
        }

        .view-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .view-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .view-btn:hover:not(.active) {
            color: #667eea;
        }

        .status-badge {
            display: inline-block;
            background: #2ecc71;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.offline {
            background: #e74c3c;
        }

        /* ===== GRID VIEW STYLES ===== */
        .grid-view {
            display: none;
        }

        .grid-view.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: #667eea;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .card-content {
            font-size: 32px;
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 8px;
        }

        .card-label {
            color: #999;
            font-size: 12px;
        }

        /* ===== TABBED VIEW STYLES ===== */
        .tabbed-view {
            display: none;
        }

        .tabbed-view.active {
            display: block;
        }

        .tabs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
            background: #f9f9f9;
        }

        .tab-button {
            flex: 1;
            padding: 20px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .tab-button:hover {
            background: #f5f5f5;
            color: #333;
        }

        .tab-button.active {
            color: #667eea;
            background: white;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .tabs-content {
            padding: 30px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== FORM & TABLE STYLES ===== */
        .form-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .form-section h3:hover {
            color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        table tbody tr:hover {
            background: #f9f9f9;
        }

        .placeholder-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .role-info {
            margin-top: 8px;
            display: block;
            font-size: 12px;
            color: #666;
        }

        footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            font-size: 12px;
        }

        footer a {
            color: white;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-controls {
                width: 100%;
                flex-direction: column;
            }

            .view-toggle {
                width: 100%;
            }

            .view-btn {
                flex: 1;
            }

            .tab-button {
                padding: 16px 12px;
                font-size: 14px;
            }

            .tabs-content {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            table th,
            table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header>
            <div class="header-left">
                <img src="/images/boostmon.png" alt="BoostMon Logo" class="header-logo">
                <div class="header-title">
                    <h1>BoostMon Dashboard</h1>
                    <p>Your Server Boost Monitor</p>
                </div>
            </div>
            <div class="header-controls">
                <div class="status-badge" id="statusBadge">Loading...</div>
                
                <!-- View Toggle -->
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchViewMode('grid')" title="Grid View">üìà Grid</button>
                    <button class="view-btn" onclick="switchViewMode('tabbed')" title="Tabbed View">üìä Tabs</button>
                </div>

                <a href="/auth/logout" style="padding: 8px 16px; background: #f0f0f0; color: #333; text-decoration: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Logout</a>
            </div>
        </header>

        <!-- ===== GRID VIEW ===== -->
        <div class="grid-view active" id="gridView">
            <div class="dashboard-grid" id="statsGrid">
                <div class="card">
                    <h2>üìä Active Timers</h2>
                    <div class="card-content" id="activeTimersGrid">0</div>
                    <div class="card-label">Timed roles currently active</div>
                </div>
                <div class="card">
                    <h2>‚è∞ Scheduled Reports</h2>
                    <div class="card-content" id="scheduledReportsGrid">0</div>
                    <div class="card-label">Role status reports</div>
                </div>
                <div class="card">
                    <h2>üóëÔ∏è Auto-Purge Settings</h2>
                    <div class="card-content" id="autopurgeCountGrid">0</div>
                    <div class="card-label">Configured channels</div>
                </div>
            </div>

            <div class="section" id="timersSection">
                <h2>‚è±Ô∏è Active Timers</h2>
                
                <!-- Role Selector -->
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="roleFilter">üîç Filter by Role:</label>
                            <select id="roleFilter" onchange="onRoleSelected()" style="width: 100%;">
                                <option value="">-- Select a Role --</option>
                            </select>
                            <span class="role-info" id="roleInfo"></span>
                        </div>
                    </div>
                </div>

                <!-- Add Entry Form (Only shown after role is selected) -->
                <div class="form-section" id="addEntryForm" style="display: none;">
                    <h3 style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 16px; color: #667eea;" onclick="toggleAddTimerForm()">
                        <span>‚ûï</span>
                        <span>Add New Timer Entry</span>
                    </h3>
                    <div class="form-grid" style="display: grid; gap: 15px;">
                        <div class="form-group">
                            <label for="newUserSearch">Select User</label>
                            <input type="text" id="newUserSearch" class="dropdown-search-input" placeholder="üîç Search users or paste Discord ID..." autocomplete="off">
                            <input type="hidden" id="newUser" required>
                        </div>
                        <div class="form-group">
                            <label for="newMinutes">Minutes</label>
                            <input type="number" id="newMinutes" placeholder="30" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="newChannel">Warning Channel (Optional)</label>
                            <select id="newChannel">
                                <option value="">-- DM warnings --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="addNewTimer()">‚ûï Add Entry</button>
                        </div>
                    </div>
                </div>

                <!-- Table Controls (Only shown after role is selected) -->
                <div class="form-section" id="tableControls" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="userSearch">Search</label>
                            <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterAndSortTimers()">
                        </div>
                        <div class="form-group">
                            <label for="statusFilter">Filter by Status</label>
                            <select id="statusFilter" onchange="filterAndSortTimers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="paused">Paused</option>
                                <option value="expired">Expired</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sortBy">Sort By</label>
                            <select id="sortBy" onchange="filterAndSortTimers()">
                                <option value="expires-asc">Expires Soonest</option>
                                <option value="expires-desc">Expires Latest</option>
                                <option value="user-asc">User (A-Z)</option>
                                <option value="user-desc">User (Z-A)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="timersList" class="placeholder-state">
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 16px;">üëÜ</div>
                        <p>Select a role above to view timers</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== TABBED VIEW ===== -->
        <div class="tabbed-view" id="tabbedView">
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="timers" onclick="switchTab('timers')">
                        ‚è±Ô∏è Active Timers
                    </button>
                    <button class="tab-button" data-tab="reports" onclick="switchTab('reports')">
                        üìã Scheduled Reports
                    </button>
                    <button class="tab-button" data-tab="autopurge" onclick="switchTab('autopurge')">
                        üóëÔ∏è Auto-Purge Settings
                    </button>
                </div>

                <div class="tabs-content">
                    <!-- TAB 1: ACTIVE TIMERS -->
                    <div class="tab-panel active" id="timers-tab">
                        <!-- ROLE FILTER SECTION -->
                        <div class="form-section" style="margin-bottom: 20px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="roleFilterTab">üîç Filter by Role:</label>
                                    <select id="roleFilterTab" onchange="onRoleSelectedTab()" style="width: 100%;">
                                        <option value="">-- Select a Role --</option>
                                    </select>
                                    <span class="role-info" id="roleInfoTab" style="margin-top: 8px; display: block;"></span>
                                </div>
                            </div>
                        </div>

                        <!-- ADD NEW TIMER (Hidden until role selected) -->
                        <div class="form-section" id="addTimerSectionTab" style="display: none; margin-bottom: 20px;">
                            <h3 style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 16px; color: #667eea;" onclick="toggleAddTimerFormTab()">
                                <span>‚ûï</span>
                                <span>Add New Timer Entry</span>
                            </h3>
                            <form id="addEntryFormTab" onsubmit="return handleAddTimerTab(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="newUserSearchTab">User</label>
                                        <input type="text" id="newUserSearchTab" placeholder="Search users..." autocomplete="off">
                                        <input type="hidden" id="newUserTab" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="newMinutesTab">Minutes</label>
                                        <input type="number" id="newMinutesTab" placeholder="30" min="1" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="newChannelTab">Warning Channel (Optional)</label>
                                        <select id="newChannelTab">
                                            <option value="">DM warnings</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">‚ûï Add Timer</button>
                                    <button type="reset" class="btn btn-secondary">Clear</button>
                                </div>
                            </form>
                        </div>

                        <!-- TIMERS TABLE -->
                        <div class="table-wrapper">
                            <table id="timersTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Role</th>
                                        <th>Time Remaining</th>
                                        <th>Expires</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="timersList">
                                    <tr><td colspan="6" class="placeholder-state">Select a role to view timers</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB 2: SCHEDULED REPORTS -->
                    <div class="tab-panel" id="reports-tab">
                        <div class="form-section">
                            <h3>‚ûï Add New Scheduled Report</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reportRole">Select Role</label>
                                    <select id="reportRole" required>
                                        <option value="">-- Select a Role --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="reportChannel">Select Channel</label>
                                    <select id="reportChannel" required>
                                        <option value="">-- Select a Channel --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="reportInterval">Interval (minutes)</label>
                                    <input type="number" id="reportInterval" placeholder="60" min="1" required>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-primary" onclick="addNewReport()" style="margin-top: 24px;">‚ûï Add Report</button>
                                </div>
                            </div>
                        </div>

                        <!-- Reports Table -->
                        <div class="table-wrapper">
                            <table id="reportsTable">
                                <thead>
                                    <tr>
                                        <th>Role</th>
                                        <th>Channel</th>
                                        <th>Interval</th>
                                        <th>Last Report</th>
                                        <th>Next Report</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                            <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
                                            No scheduled reports yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB 3: AUTO-PURGE SETTINGS -->
                    <div class="tab-panel" id="autopurge-tab">
                        <div class="form-section">
                            <h3>‚ûï Add Auto-Purge Setting</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="autopurgeChannel">Channel to Purge</label>
                                    <select id="autopurgeChannel" required>
                                        <option value="">Select a channel...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="autopurgeType">Message Type</label>
                                    <select id="autopurgeType" required>
                                        <option value="">Select message type...</option>
                                        <option value="bot">Bot messages only</option>
                                        <option value="user">User messages only</option>
                                        <option value="both">Both bot and user</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="autopurgeLines">Messages to Delete</label>
                                    <input id="autopurgeLines" type="number" min="1" placeholder="10" required>
                                </div>
                                <div class="form-group">
                                    <label for="autopurgeInterval">Interval (minutes)</label>
                                    <input id="autopurgeInterval" type="number" min="1" placeholder="30" required>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-primary" onclick="addNewAutopurge()" style="margin-top: 24px;">‚ûï Add Auto-Purge</button>
                                </div>
                            </div>
                        </div>

                        <!-- Autopurge Table -->
                        <div class="table-wrapper">
                            <table id="autopurgeTable">
                                <thead>
                                    <tr>
                                        <th>Channel</th>
                                        <th>Type</th>
                                        <th>Messages</th>
                                        <th>Interval</th>
                                        <th>Last Purge</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="autopurgeTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                            <div style="font-size: 48px; margin-bottom: 16px;">üóëÔ∏è</div>
                                            No auto-purge settings yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <p>BoostMon Dashboard ‚Ä¢ v<span id="versionDisplay">2.1.63</span> ‚Ä¢ <a href="#" onclick="toggleDebugPanel(); return false;">üêõ Debug</a></p>
    </footer>

    <script>
        let guildId = null;
        let selectedRoleId = null;
        let selectedRoleIdTab = null;
        let allTimers = [];
        let allRoles = [];
        let currentViewMode = 'grid';

        // ===== VIEW MODE TOGGLE =====
        function switchViewMode(mode) {
            currentViewMode = mode;
            const gridView = document.getElementById('gridView');
            const tabbedView = document.getElementById('tabbedView');
            const viewBtns = document.querySelectorAll('.view-btn');

            if (mode === 'grid') {
                gridView.classList.add('active');
                tabbedView.classList.remove('active');
                viewBtns[0].classList.add('active');
                viewBtns[1].classList.remove('active');
            } else {
                gridView.classList.remove('active');
                tabbedView.classList.add('active');
                viewBtns[0].classList.remove('active');
                viewBtns[1].classList.add('active');
                populateRoleFilterTab();
            }
        }

        // ===== TAB SWITCHING =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // ===== GUILD ID HANDLING =====
        function getGuildId() {
            const params = new URLSearchParams(window.location.search);
            const urlGuildId = params.get('guild');
            
            if (urlGuildId) {
                sessionStorage.setItem('guildId', urlGuildId);
                return urlGuildId;
            }
            
            return sessionStorage.getItem('guildId');
        }

        // ===== AUTHENTICATION =====
        async function checkAuth() {
            try {
                const response = await fetch('/auth/user', {
                    credentials: 'include'
                });
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return false;
                }
                return true;
            } catch (err) {
                window.location.href = '/login.html';
                return false;
            }
        }

        // ===== LOAD DASHBOARD DATA =====
        async function loadDashboard() {
            try {
                guildId = getGuildId();
                if (!guildId) {
                    window.location.href = '/guild-select.html';
                    return;
                }
                
                const url = `/api/dashboard?guildId=${guildId}`;
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (response.status === 403 || response.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                
                if (!response.ok) throw new Error('Failed to load dashboard data');
                
                const data = await response.json();
                updateDashboard(data);
            } catch (err) {
                console.error('Dashboard error:', err);
                document.getElementById('statusBadge').textContent = 'ERROR';
                document.getElementById('statusBadge').classList.add('offline');
            }
        }

        function updateDashboard(data) {
            const statusBadge = document.getElementById('statusBadge');
            if (data.botStatus === 'online') {
                statusBadge.textContent = 'üü¢ ONLINE';
                statusBadge.classList.remove('offline');
            } else {
                statusBadge.textContent = 'üî¥ OFFLINE';
                statusBadge.classList.add('offline');
            }

            // Update grid view stats
            document.getElementById('activeTimersGrid').textContent = data.stats?.activeTimers || 0;
            document.getElementById('scheduledReportsGrid').textContent = data.stats?.scheduledReports || 0;
            document.getElementById('autopurgeCountGrid').textContent = data.stats?.autopurgeSettings || 0;

            allTimers = data.timers || [];
            
            // Extract unique roles from timers
            const roleMap = new Map();
            allTimers.forEach(timer => {
                if (!roleMap.has(timer.roleId)) {
                    roleMap.set(timer.roleId, timer.role);
                }
            });
            
            allRoles = Array.from(roleMap.entries()).map(([id, name]) => ({ id, name }))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            // Populate role selector for grid view
            populateRoleFilter();
        }

        function populateRoleFilter() {
            const roleSelect = document.getElementById('roleFilter');
            const currentValue = roleSelect.value;
            roleSelect.innerHTML = '<option value="">-- Select a Role --</option>';
            
            allRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                roleSelect.appendChild(option);
            });
            
            if (currentValue && allRoles.find(r => r.id === currentValue)) {
                roleSelect.value = currentValue;
            }
        }

        function populateRoleFilterTab() {
            const roleSelect = document.getElementById('roleFilterTab');
            roleSelect.innerHTML = '<option value="">-- Select a Role --</option>';
            
            allRoles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                roleSelect.appendChild(option);
            });
        }

        // ===== GRID VIEW: ROLE SELECTION =====
        function onRoleSelected() {
            selectedRoleId = document.getElementById('roleFilter').value;
            const addEntryForm = document.getElementById('addEntryForm');
            const tableControls = document.getElementById('tableControls');
            const roleInfo = document.getElementById('roleInfo');
            
            if (selectedRoleId) {
                addEntryForm.style.display = 'block';
                tableControls.style.display = 'block';
                const timerCount = allTimers.filter(t => t.roleId === selectedRoleId).length;
                roleInfo.textContent = `üìä ${timerCount} timer${timerCount !== 1 ? 's' : ''} active for this role`;
                filterAndSortTimers();
            } else {
                addEntryForm.style.display = 'none';
                tableControls.style.display = 'none';
                roleInfo.textContent = '';
                document.getElementById('timersList').innerHTML = '<div class="empty-state"><div style="font-size: 48px; margin-bottom: 16px;">üëÜ</div><p>Select a role above to view timers</p></div>';
            }
        }

        function toggleAddTimerForm() {
            const form = document.getElementById('addEntryForm');
            const content = form.querySelector('div.form-grid');
            if (content.style.display === 'none') {
                content.style.display = 'grid';
            } else {
                content.style.display = 'none';
            }
        }

        // ===== TABBED VIEW: ROLE SELECTION =====
        function onRoleSelectedTab() {
            selectedRoleIdTab = document.getElementById('roleFilterTab').value;
            const addTimerSection = document.getElementById('addTimerSectionTab');
            const roleInfo = document.getElementById('roleInfoTab');
            
            if (selectedRoleIdTab) {
                addTimerSection.style.display = 'block';
                const timerCount = allTimers.filter(t => t.roleId === selectedRoleIdTab).length;
                roleInfo.textContent = `üìä ${timerCount} timer${timerCount !== 1 ? 's' : ''} active for this role`;
                filterTimersByRoleTab();
            } else {
                addTimerSection.style.display = 'none';
                roleInfo.textContent = '';
                document.getElementById('timersList').innerHTML = '<tr><td colspan="6" class="placeholder-state">Select a role to view timers</td></tr>';
            }
        }

        function toggleAddTimerFormTab() {
            const form = document.getElementById('addEntryFormTab');
            const isHidden = form.style.display === 'none';
            form.style.display = isHidden ? 'block' : 'none';
        }

        function filterTimersByRoleTab() {
            if (!selectedRoleIdTab) {
                document.getElementById('timersList').innerHTML = '<tr><td colspan="6" class="placeholder-state">Select a role to view timers</td></tr>';
                return;
            }

            const filtered = allTimers.filter(t => t.roleId === selectedRoleIdTab);
            updateTimersTable(filtered);
        }

        function updateTimersTable(timers) {
            const tbody = document.getElementById('timersList');
            
            if (!timers || timers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="placeholder-state">No timers for this role</td></tr>';
                return;
            }

            tbody.innerHTML = timers.map(timer => {
                const now = Date.now();
                const timeLeft = Math.max(0, timer.expiresAt - now);
                const hours = Math.floor(timeLeft / 3600000);
                const minutes = Math.floor((timeLeft % 3600000) / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);

                const status = timer.paused ? '‚è∏Ô∏è Paused' : timeLeft <= 0 ? 'üî¥ Expired' : 'üü¢ Active';
                const expiresDate = new Date(timer.expiresAt).toLocaleString();

                return `
                    <tr>
                        <td><strong>${timer.user}</strong></td>
                        <td>${timer.role}</td>
                        <td>${hours}h ${minutes}m ${seconds}s</td>
                        <td>${expiresDate}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteTimer('${timer.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterAndSortTimers() {
            if (!selectedRoleId) return;
            
            let filtered = allTimers.filter(t => t.roleId === selectedRoleId);
            
            // Apply filters
            const userSearch = document.getElementById('userSearch')?.value.toLowerCase() || '';
            if (userSearch) {
                filtered = filtered.filter(t => t.user.toLowerCase().includes(userSearch));
            }

            const statusFilter = document.getElementById('statusFilter')?.value || '';
            if (statusFilter === 'active') {
                filtered = filtered.filter(t => !t.paused && t.expiresAt > Date.now());
            } else if (statusFilter === 'paused') {
                filtered = filtered.filter(t => t.paused);
            } else if (statusFilter === 'expired') {
                filtered = filtered.filter(t => t.expiresAt <= Date.now());
            }

            // Apply sorting
            const sortBy = document.getElementById('sortBy')?.value || 'expires-asc';
            switch(sortBy) {
                case 'expires-asc':
                    filtered.sort((a, b) => a.expiresAt - b.expiresAt);
                    break;
                case 'expires-desc':
                    filtered.sort((a, b) => b.expiresAt - a.expiresAt);
                    break;
                case 'user-asc':
                    filtered.sort((a, b) => a.user.localeCompare(b.user));
                    break;
                case 'user-desc':
                    filtered.sort((a, b) => b.user.localeCompare(a.user));
                    break;
            }

            // Update grid view table
            const container = document.getElementById('timersList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div style="font-size: 48px; margin-bottom: 16px;">‚è∞</div><p>No timers match your filters</p></div>';
                return;
            }

            let html = '<div class="table-wrapper"><table><thead><tr><th>User</th><th>Time Remaining</th><th>Expires</th><th>Status</th><th style="text-align: right;">Actions</th></tr></thead><tbody>';

            filtered.forEach(timer => {
                const badge = timer.paused ? 'badge-paused' : timer.expiresAt <= Date.now() ? 'badge-expired' : 'badge-active';
                const status = timer.paused ? '‚è∏Ô∏è PAUSED' : timer.expiresAt <= Date.now() ? 'üî¥ EXPIRED' : 'üü¢ ACTIVE';
                
                const now = Date.now();
                const timeLeft = Math.max(0, timer.expiresAt - now);
                const hours = Math.floor(timeLeft / 3600000);
                const minutes = Math.floor((timeLeft % 3600000) / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                
                html += `
                    <tr>
                        <td><strong>${timer.user}</strong></td>
                        <td>${hours}h ${minutes}m ${seconds}s</td>
                        <td>${new Date(timer.expiresAt).toLocaleString()}</td>
                        <td><span class="badge ${badge}">${status}</span></td>
                        <td style="text-align: right;">
                            <button class="btn btn-danger" onclick="deleteTimer('${timer.id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function addNewTimer() {
            const userId = document.getElementById('newUser').value;
            const minutes = document.getElementById('newMinutes').value;
            const channelId = document.getElementById('newChannel').value;

            if (!userId || !minutes || !selectedRoleId) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch(`/api/timer/add?guildId=${guildId}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, roleId: selectedRoleId, minutes, channelId: channelId || null })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add timer');
                }

                alert('Timer added successfully!');
                document.getElementById('newUser').value = '';
                document.getElementById('newMinutes').value = '';
                document.getElementById('newChannel').value = '';
                await loadDashboard();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function deleteTimer(timerId) {
            if (!confirm('Are you sure you want to delete this timer?')) return;

            try {
                const response = await fetch(`/api/timer/delete?guildId=${guildId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timerId })
                });

                if (!response.ok) throw new Error('Failed to delete timer');

                alert('Timer deleted successfully!');
                await loadDashboard();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function addNewReport() {
            alert('Report functionality coming soon');
        }

        async function addNewAutopurge() {
            alert('Auto-purge functionality coming soon');
        }

        function toggleDebugPanel() {
            // Placeholder for debug panel
            alert('Debug panel coming soon');
        }

        // ===== INITIALIZATION =====
        (async () => {
            const isAuth = await checkAuth();
            if (isAuth) {
                await loadDashboard();
                // Reload every 30 seconds
                setInterval(loadDashboard, 30000);
            }
        })();
    </script>
</body>
</html>
